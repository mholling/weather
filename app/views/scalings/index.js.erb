$.extend({
  keys: function(obj) {
    var a = [];
    $.each(obj, function(k){ a.push(k) });
    return a;
  }
});

var app = {
  init: function() {
    this.tabs.init();
    this.scales.init();
    this.scalings.init();
    this.sortable.init();
  },
  
  tabs: {
    init: function() {
      $('#tabs').tabs({
        select: function(event, ui) {
          app.scalings.loadScale(ui.index)
        }
      });
    },
    
    selectedTab: function() {
      return $('#tabs').tabs('option', 'selected');
    }
  },
  
  scales: {
    init: function() {
      $('.scale .date').data('date', new Date());
      <%- @scalings.map(&:scale).uniq.each do |scale| -%>
        $('#<%= dom_id(scale) %>').children('a.show').each(function(index, anchor) {
          jQuery.get(anchor.href, null, null, 'script');
        });
      <%- end -%>
    },
  },
  
  scalings: {
    init: function() {
      $('.scaling .content').empty();
      this.loadScale(app.tabs.selectedTab());
    },
    
    loadScale: function(tabIndex) {
      this.load($('.scale:eq('+tabIndex+') .scaling .content:empty').parents('.scaling'));
    },
    
    load: function(scalings) {
      scalings.find('.content').css("background", "url(/images/ajax-loader.gif) center no-repeat")
      scalings.find('a.show').each(function(index, anchor) {
        data = { date: scalings.parents('.scale').find('.date').data('date').toDateString() }
        jQuery.get(anchor.href, data, function() {
          $(anchor).parents('.scaling').find('.content').css("background", "none")
        }, 'script');
      });
    }
  },

  sortable: {
    init: function() {
      $('.scalings').sortable({
        handle: '.handle',
        placeholder: 'ui-state-highlight',
        forcePlaceholderSize: true,
        update: function(event, ui) {
          data = {
            _method: 'PUT',
            position: $(event.target).find('.scaling').index(ui.item)
          };
          $.post(ui.item.find('a.move').get(0).href, data);          
        }
      });
      $('.scalings .handle').disableSelection();
    }
  }
};

$(function() {
  app.init();
})


